from telegram import Update 
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes, MessageHandler, filters

import io
import os #–º–æ–¥—É–ª—å –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π, –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏, –æ–∫—Ä—É–∂–µ–Ω–∏–µ–º –∏ –¥—Ä—É–≥–∏–º–∏ –∞—Å–ø–µ–∫—Ç–∞–º–∏ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã.
import psycopg2 # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö PostgreSQL –∏–∑ Python.
import datetime # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–∞–º–∏ –∏ –≤—Ä–µ–º–µ–Ω–µ–º.
import logging # –î–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –≤ –ø—Ä–æ–≥—Ä–∞–º–º
import requests # –î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤
import matplotlib.pyplot as plt # –î–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
from functools import wraps


# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è. –ó–∞–¥–∞—ë—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤ –∏ —É—Ä–æ–≤–µ–Ω—å (INFO)
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

# logging.debug("–≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏")
# logging.info("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")
# logging.warning("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –≤–æ–∑–º–æ–∂–Ω–æ–π –ø—Ä–æ–±–ª–µ–º–µ")
# logging.error("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞")
# logging.critical("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞!")


# –ß—Ç–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:
TOKEN = os.getenv("BOT_TOKEN") # –¢–æ–∫–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã Telegram-–±–æ—Ç–∞
#Python –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è —Å –∏–º–µ–Ω–µ–º BOT_TOKEN –∏–∑ —Ç–µ–∫—É—â–µ–π —Å—Ä–µ–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã, 
#Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –∏–ª–∏ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ä–µ–¥—ã –≤ IDE).
#API —Ç–æ–∫–µ–Ω—ã ‚Äî —ç—Ç–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏ —á–µ—Ä–µ–∑ –∏—Ö API (Application Programming Interface ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π). 
#–¢–æ–∫–µ–Ω—ã API –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è —Å–µ—Ä–≤–∏—Å–∞–º–∏ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –º–æ–≥–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –∏—Ö —Ä–µ—Å—É—Ä—Å–∞–º
URL = os.getenv("DATABASE_URL") # URL –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö PostgreSQL
API_KEY = os.getenv("API_KEY") # –ö–ª—é—á API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç
#–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (os.getenv): –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (—Ç–æ–∫–µ–Ω–æ–≤ –∏ –∫–ª—é—á–µ–π).
#–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è API_KEY —Ö—Ä–∞–Ω–∏—Ç —Ç–æ–∫–µ–Ω API, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ, –Ω–æ —Å–∞–º —Ç–æ–∫–µ–Ω –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –ø—Ä—è–º–æ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –∫–æ–¥–µ.

# –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Ö –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
# –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º–µ –æ–∂–∏–¥–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.
#–≠—Ç–æ –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –∑–∞–¥–∞—á, –µ—Å–ª–∏ –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ —Ä–∞–º–∫–∞—Ö –±–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)
async def get_rates(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None: 
    """
    –§—É–Ω–∫—Ü–∏—è –¥–∞–µ—Ç –∫—É—Ä—Å –≤–∞–ª—é—Ç —Ç–µ–∫—É—â—É—é.
    """# URL API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç
    url = 'https://openexchangerates.org/api/latest.json' #?app_id=6325952bd484428489f6aa5cbd05b08b" (–í API-–∑–∞–ø—Ä–æ—Å–∞—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —á–∞—Å—Ç–æ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ URL –∫–∞–∫ –∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä—ã. –ù–∞–ø—Ä–∏–º–µ—Ä, –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –∫–ª—é—á app_id —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ —Å–µ—Ä–≤–∏—Å–µ API.)
    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ –∫ API
    params = {
        'app_id':API_KEY, #–≠—Ç–æ —Å–ª–æ–≤–∞—Ä—å Python, –≤ –∫–æ—Ç–æ—Ä–æ–º —Ö—Ä–∞–Ω–∏—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä app_id –∏ –µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π API –∫–ª—é—á.
        'base':None, # –ë–∞–∑–æ–≤–∞—è –≤–∞–ª—é—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é USD, –µ—Å–ª–∏ None).
        'symbols':None, # –°–ø–∏—Å–æ–∫ –≤–∞–ª—é—Ç, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –Ω—É–∂–Ω—ã –∫—É—Ä—Å—ã (–µ—Å–ª–∏ None, —Ç–æ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ).
    }
    # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ GET-–∑–∞–ø—Ä–æ—Å–∞ –∫ API.
    response = requests.get(url, params=params)#params- –ù–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é —Å–æ–±–∏—Ä–∞—Ç—å URL-—Å—Ç—Ä–æ–∫—É, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∫ –∑–∞–ø—Ä–æ—Å—É.
    # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç API –≤ Telegram.
    await update.message.reply_text(response.text) #reply_text() ‚Äî —ç—Ç–æ –º–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–æ—Ç—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç –≤ –æ—Ç–≤–µ—Ç –Ω–∞ –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. 
    #–í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ, —ç—Ç–æ —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –æ–±—Ä–∞—Ç–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –Ω–µ –±–ª–æ–∫–∏—Ä—É—è –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞
    #response ‚Äî —ç—Ç–æ –æ–±—ä–µ–∫—Ç, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ HTTP-–∑–∞–ø—Ä–æ—Å–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ requests
    #response.text ‚Äî —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∞—è —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –æ—Ç API, –∫–æ—Ç–æ—Ä—ã–π –æ–±—ã—á–Ω–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –∏–ª–∏ –¥—Ä—É–≥–æ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
    # –ü–∞—Ä—Å–∏—Ç –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –≤ —Ñ–æ—Ä–º–∞—Ç JSON, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ª–µ–≥–∫–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏. –≤ Python-—Å–ª–æ–≤–∞—Ä—å
    data = response.json() 
    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç, –±–∞–∑–æ–≤–æ–π –≤–∞–ª—é—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞.
    rates = data.get("rates",{})
    base_currency = data.get("base")
    timestamp = data.get("timestamp")
    date= datetime.datetime.fromtimestamp(timestamp).date() # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–∏ –≤ –¥–∞—Ç—É.
    # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö PostgreSQL.
    conn=psycopg2.connect(URL) #—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ —ç—Ç–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π ( –∏–∑ .env —Ñ–∞–π–ª–∞) –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–∞–∫—É—é —Å—Ç—Ä–æ–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.
    cursor = conn.cursor()
    #–ö—É—Ä—Å–æ—Ä ‚Äî —ç—Ç–æ –æ–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤. 
    #–û–Ω –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã, –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏.
    # –¶–∏–∫–ª –ø–æ –≤—Å–µ–º –≤–∞–ª—é—Ç–∞–º –∏ –∏—Ö –∫—É—Ä—Å–∞–º
    for currency, rate in rates.items():
        # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL-–∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö. –ü–µ—Ä–µ–¥–∞–µ—Ç–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –≤–∏–¥–µ –∫–æ—Ä—Ç–µ–∂–∞ –∏–ª–∏ —Å–ø–∏—Å–∫–∞:
        cursor.execute("""
                    insert into rates (base_currency, date, currency, rate)
                    values (%s,%s,%s,%s) 
                    on conflict (base_currency, date, currency) do update 
                       set rate = excluded.rate
                    """, (base_currency, date, currency, rate))
     #—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–µ—Ö–∞–Ω–∏–∑–º–∞ ON CONFLICT –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤. –≠—Ç–æ—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å—Å—è –ø–æ —Ç—Ä–æ–π–∫–µ —Å—Ç–æ–ª–±—Ü–æ–≤:
     #base_currency, date –∏ currency. –ï—Å–ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∑–∞–ø–∏—Å—å —Å —Ç–∞–∫–∏–º –∂–µ —Å–æ—á–µ—Ç–∞–Ω–∏–µ–º –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è —ç—Ç–∏—Ö —Å—Ç–æ–ª–±—Ü–æ–≤, —Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç.
     #PostgreSQL –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å —Å—Ç–æ–ª–±–µ—Ü rate –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–ø–∏—Å–∏ –∑–Ω–∞—á–µ–Ω–∏–µ–º excluded.rate, —Ç.–µ. –∑–Ω–∞—á–µ–Ω–∏–µ–º, –∫–æ—Ç–æ—Ä–æ–µ –ø—ã—Ç–∞–ª–∏—Å—å –≤—Å—Ç–∞–≤–∏—Ç—å.
     
     #%s ‚Äî —ç—Ç–æ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –ø–µ—Ä–µ–¥–∞–Ω—ã –ø–æ–∑–∂–µ –≤ –∑–∞–ø—Ä–æ—Å. –û–Ω –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é SQL-—Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞, –∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–Ω–∞—á–µ–Ω–∏–π. 
     #–ó–∞—â–∏—Ç–∞ –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π
     #–ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –∑–∞–º–µ–Ω—è—é—Ç—Å—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º–∏ –≤ –∑–∞–ø—Ä–æ—Å, –≤–æ –≤—Ä–µ–º—è –µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

     # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
    conn.commit()
    # –ó–∞–∫—Ä—ã—Ç–∏–µ –∫—É—Ä—Å–æ—Ä–∞ –∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
    cursor.close()
    conn.close()

     # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –≤–∞–ª—é—Ç –∏ –¥–∞—Ç–µ.
    await update.message.reply_text(f"–û–±–º–µ–Ω–Ω—ã–µ –∫—É—Ä—Å—ã –¥–ª—è {len(rates)} –≤–∞–ª—é—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö {date}")
#—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ (f-—Å—Ç—Ä–æ–∫–∞), –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Å—Ç—Ä–æ–∫—É. 
# –§—É–Ω–∫—Ü–∏—è len(rates) –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å–ª–æ–≤–∞—Ä–µ rates, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç.
#{date} ‚Äî –≤—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∞—Ç—É, –∫–æ—Ç–æ—Ä–∞—è —É–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–æ–≥–¥–∞ –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ. –≠—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∏–∑ datetime.datetime.fromtimestamp(timestamp).date(),
# —Ç–æ –µ—Å—Ç—å —ç—Ç–æ –¥–∞—Ç–∞, –ø–æ–ª—É—á–µ–Ω–Ω–∞—è –∏–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–∏ timestamp

async def get_historical_rates(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Ö –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
    """
    # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä–∏–æ–¥–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:#–ë–ª–æ–∫, –≤ –∫–æ—Ç–æ—Ä–æ–º –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫ –≤ –¥–∞—Ç—ã. –ë–ª–æ–∫ try-except –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–µ —É–ø–∞–ª–∞ —Å –æ—à–∏–±–∫–æ–π, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–¥–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –∏–ª–∏ –∑–∞–±—É–¥–µ—Ç —É–∫–∞–∑–∞—Ç—å –æ–¥–Ω—É –∏–∑ –¥–∞—Ç.
         #–í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–æ—Å—å–±–æ–π –≤–≤–µ—Å—Ç–∏ –¥–∞—Ç—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.

        start_date = context.args[0]  # –û–∂–∏–¥–∞–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ 'YYYY-MM-DD'
        end_date = context.args[1]    # –û–∂–∏–¥–∞–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ 'YYYY-MM-DD'
        #–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫–∏ –≤ –æ–±—ä–µ–∫—Ç—ã  datetime
        start_date = datetime.datetime.strptime(start_date, "%Y-%m-%d").date()
        end_date = datetime.datetime.strptime(end_date, "%Y-%m-%d").date()
    except (IndexError, ValueError): #–±–ª–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏
        await update.message.reply_text("–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ: /get_historical_rates YYYY-MM-DD YYYY-MM-DD")
        return #–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è return, —á—Ç–æ–±—ã —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å –∏ –Ω–µ –ø—Ä–æ–¥–æ–ª–∂–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –±—ã–ª–∏ –ø–æ–ª—É—á–µ–Ω—ã

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç
    if start_date > end_date:
        await update.message.reply_text("–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è.")
        return

    conn = psycopg2.connect(URL)
    cursor = conn.cursor()

    total_days = (end_date - start_date).days + 1
    current_date = start_date
    #–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–≥–ª—É—à–∫–æ–π
    progress_message = await update.message.reply_text("‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...")
    # –°–ø–∏—Å–æ–∫ —ç–º–æ–¥–∑–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
    fancy_frames = ["üåë", "üåí", "üåì", "üåî", "üåï", "üåñ", "üåó", "üåò"]
    completed_icon = "üü©"  # –ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–∞—è —á–∞—Å—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    remaining_icon = "‚¨úÔ∏è"  # –û—Å—Ç–∞—Ç–æ–∫
    
    processed_days = 0
    while current_date <= end_date:
        #–§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
        date_str = current_date.strftime("%Y-%m-%d")

        #–§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è API
        url = f'https://openexchangerates.org/api/historical/{current_date}.json'
        params = {
            'app_id': API_KEY,
            'base': None,
            'symbols': None,
        }
        #–í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
        response = requests.get(url, params=params)
        if response.status_code != 200:
            await update.message.reply_text(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –¥–∞–Ω–Ω—ã—Ö –∑–∞ {current_date}: {response.status_code}")
            current_date += datetime.timedelta(days=1)
            continue
        #–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        data = response.json()
        rates = data.get("rates", {})
        base_currency = data.get("base")
        timestamp = data.get("timestamp")
        date = datetime.datetime.fromtimestamp(timestamp).date()

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑—É
        for currency, rate in rates.items():
            cursor.execute("""
                INSERT INTO rates (base_currency, date, currency, rate)
                VALUES (%s, %s, %s, %s)
                ON CONFLICT (base_currency, date, currency) DO UPDATE
                   SET rate = EXCLUDED.rate
            """, (base_currency, date, currency, rate))

        conn.commit()
        #await update.message.reply_text(f"–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –∑–∞ {current_date} —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.")
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        processed_days += 1
        progress = int((processed_days / total_days) * 100)
        #–§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
        progress_bar = f"[{completed_icon * (progress // 10)}{remaining_icon * (10 - progress // 10)}] {progress}%"

        # –ú–µ–Ω—è—é—â–∏–π—Å—è –∫–∞–¥—Ä –∞–Ω–∏–º–∞—Ü–∏–∏
        frame = fancy_frames[processed_days % len(fancy_frames)]

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        await progress_message.edit_text(
            f"‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...\n{progress_bar}\n{frame} –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º {date_str}\n"
            f"üìÖ –û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π: {total_days - processed_days}"
        )
       ##progress_bar = f"[{'#' * (progress // 10)}{'.' * (10 - progress // 10)}] {progress}%"
        ##await progress_message.edit_text(f"‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...\n{progress_bar}")
        current_date += datetime.timedelta(days=1)

    cursor.close()
    conn.close()
    #await update.message.reply_text(f"–û–±–º–µ–Ω–Ω—ã–µ –∫—É—Ä—Å—ã –∑–∞ –ø–µ—Ä–∏–æ–¥ {start_date} ‚Äî {end_date} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.")
    ##await progress_message.edit_text(f"‚úÖ –û–±–º–µ–Ω–Ω—ã–µ –∫—É—Ä—Å—ã –∑–∞ –ø–µ—Ä–∏–æ–¥ {start_date} ‚Äî {end_date} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.")
    #–§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–∞–º–∏ üéÜ
    fireworks = "üéÜ‚ú®üéá"
    await progress_message.edit_text(
        f"‚úÖ {fireworks} –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–µ—Ä–∏–æ–¥ {start_date} ‚Äî {end_date} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã! {fireworks}\n"
        f"–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –±–æ—Ç–æ–º!"
    )
# –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
def authorize(func):
    @wraps(func)
    async def wrapper(update: Update, context: ContextTypes.DEFAULT_TYPE, *args, **kwargs):
        user_username = update.message.from_user.username
        return await func(update, context, *args, **kwargs)#!!!–¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞ —Ä–∞—Å–∫–æ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∏–∂–µ –∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É
        # if user_username == "avonadzh":
        #     return await func(update, context, *args, **kwargs)
        # else:
        #     await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
    return wrapper

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–º
@authorize
async def plot(update: Update, context: ContextTypes.DEFAULT_TYPE)-> None:
    #–û–±—ä–µ–∫—Ç Update —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ö–æ–¥—è—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–µ–∫—Å—Ç, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¥—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ. –≠—Ç–æ –æ–±—ä–µ–∫—Ç, 
    # –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –≤–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É.
    #–æ–±—ä–µ–∫—Ç context, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∫–æ–º–∞–Ω–¥—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º –∫–æ–º–∞–Ω–¥—ã, —Å–æ—Å—Ç–æ—è–Ω–∏—é –∏ —Ç. –¥. 
    # –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ, context.args[0] ‚Äî —ç—Ç–æ –ø–µ—Ä–≤—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç –∫–æ–º–∞–Ω–¥—ã, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –≤–∞–ª—é—Ç–æ–π, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    """
    –§—É–Ω–∫—Ü–∏—è —Ä–∏—Å—É–µ—Ç –≥—Ä–∞—Ñ–∏–∫ –∫—É—Ä—Å–∞ –≤–∞–ª—é—Ç –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.
    """
    try:
        currency = context.args[0].upper() #–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª –∫–æ–º–∞–Ω–¥—É —Å –≤–∞–ª—é—Ç–æ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä: /plot USD
    except:
        await update.message.reply_text(f"–û—à–∏–±–∫–∞: —É–∫–∞–∂–∏—Ç–µ –≤–∞–ª—é—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ /plot USD")

    await update.message.reply_text(f"–î–∞–Ω–Ω—ã–µ –ø–æ {currency}")
    #–º–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ —á–∞—Ç. –°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∞–ª—é—Ç–µ, 
    #–ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–π –≤ –∫–æ–º–∞–Ω–¥—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–î–∞–Ω–Ω—ã–µ –ø–æ USD").
    try: #–ù–∞—á–∏–Ω–∞–µ—Ç –±–ª–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –¥–ª—è –æ—Ç–ª–æ–≤–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.
     #–ü–æ—á–µ–º—É: –†–∞–±–æ—Ç–∞ —Å –ë–î –º–± –ø–æ–¥–≤–µ—Ä–∂–µ–Ω–∞ –º–Ω–æ–∂ –æ—à–∏–±–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª)
        conn = psycopg2.connect(URL)
        #–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î –∏—Å–ø URL.–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ–æ–±—Ö –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤
        cursor = conn.cursor()
        #–°–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç cursor, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤. 
        # f-—Å—Ç—Ä–æ–∫–∏ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π currency –≤ –∑–∞–ø—Ä–æ—Å
        # cursor.execute(f"""select date, rate from rates where currency = '{currency}' 
        #                 and date >= '2024-12-01'
        #                 order by date;""")
        
        # cursor.execute(f"""
        #     SELECT date, rate 
        #     FROM rates 
        #     WHERE currency = '{currency}' 
        #     AND date >= (
        #         SELECT MAX(date) - INTERVAL '7 days'
        #         FROM rates
        #         WHERE currency = '{currency}'
        #     )
        #     ORDER BY date;
        # """)
        #!!!–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–æ–¥—Ö–æ–¥: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã %s 
        # –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ %s, –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç —Å—Ç—Ä–æ–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –∏ –Ω–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ SQL-–∫–æ–¥
        #–û–±—â–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:
        #–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
        #–ò–∑–±–µ–≥–∞–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è f-—Å—Ç—Ä–æ–∫ –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ.
        #–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –≤–≤–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —á—Ç–æ–±—ã –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∏—Å–∫–∏.
        cursor.execute("""
            SELECT date, rate 
            FROM rates 
            WHERE currency = %s 
            AND date >= (
                SELECT MAX(date) - INTERVAL '7 days'
                FROM rates
                WHERE currency = %s
            )
            ORDER BY date;
        """, (currency, currency))

        #""" –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—Ç—Ä–æ–∫–∏ –¥–æ –∏ –ø–æ—Å–ª–µ
        result = cursor.fetchall() #–ò–∑–≤–ª–µ–∫–∞–µ—Ç –≤—Å–µ —Å—Ç—Ä–æ–∫–∏, –≤–æ–∑–≤—Ä–∞—â–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–æ–º, –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Ö –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é result
        #–û–Ω –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–æ—Ä—Ç–µ–∂–µ–π, –≥–¥–µ –∫–∞–∂–¥—ã–π –∫–æ—Ä—Ç–µ–∂ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∑–∞–ø—Ä–æ—Å–∞.
        # await update.message.reply_text (f"–î–∞–Ω–Ω—ã–µ –ø–æ {result}")
        conn.commit() 
        #–§–∏–∫—Å–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        cursor.close()
        conn.close()
        #–ó–∞–∫—Ä—ã–≤–∞–µ—Ç –∫—É—Ä—Å–æ—Ä –∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö. –û—Ç–∫—Ä—ã—Ç—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–æ—Ç—Ä–µ–±–ª—è—é—Ç —Ä–µ—Å—É—Ä—Å—ã.
    except Exception as e:
        logging.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:{e}")
        #print(f'–û—à–∏–±–∫–∞:{e}')
        await update.message.reply_text(f'–û—à–∏–±–∫–∞:{e}')

    date = [datetime.datetime.strftime(d[0], '%Y-%m-%d') for d in result]
    #–ø–æ–ª—É—á–∏–ª–∏ —Å–ø–∏—Å–æ–∫ –¥–∞—Ç –ø–æ –≤–∞–ª—é—Ç–µ
    rates = [d[1] for d in result]
    #–ø–æ–ª—É—á–∏–ª–∏ —Å–ø–∏—Å–æ–∫ –∑–Ω–∞—á–µ–Ω–∏–π –æ–±–º–µ–Ω–Ω–æ–≥–æ –∫—É—Ä—Å–∞ –ø–æ –≤–∞–ª—é—Ç–µ

    # await update.message.reply_text(f"–î–∞–Ω–Ω—ã–µ –ø–æ {date}")
    # await update.message.reply_text(f"–î–∞–Ω–Ω—ã–µ –ø–æ {rates}")

    plt.figure(figsize= (14,8))
    #–°–æ–∑–¥–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–∑–º–µ—Ä–æ–º 14 –Ω–∞ 8
    #dates  –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –æ—Å–∏–∏ x, rates –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –æ—Å–∏  y
    plt.plot(date,rates,marker = 'o', label= f"–û–±–º–µ–Ω–Ω—ã–π –∫—É—Ä—Å USD –∫ {currency}")
    plt.xlabel ('–î–∞—Ç–∞')
    plt.ylabel ('–û–±–º–µ–Ω–Ω—ã–π –∫—É—Ä—Å')
    plt.legend #–î–æ–±–∞–≤–ª—è–µ–º –ª–µ–≥–µ–Ω–¥—É
    plt.grid #–î–æ–±–∞–≤–ª—è–µ–º —Å–µ—Ç–∫—É
    plt.xticks(rotation=40) #–∏–∑–º–µ–Ω—è–µ–º —É–≥–æ–ª –Ω–∞–∫–ª–æ–Ω–∞ –Ω–∞–¥–ø–∏—Å–µ–π –Ω–∞ –æ—Å–∏ X
    buf =io.BytesIO()
    #–°–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –±—É—Ñ–µ—Ä –æ–±–º –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–æ–±—Ä
    plt.savefig(buf, format ='png')
    #—Å–æ—Ö—Ä–∞–Ω—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ø–Ω–≥ –≤ –±—É—Ñ–µ—Ä
    buf.seek(0)
    #–ü–µ—Ä–µ–º–µ—â–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –≤ –Ω–∞—á–∞–ª–æ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞ —á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ  –º–æ–∂–Ω–æ –±—ã–ª–æ —Å—á–∏—Ç–∞—Ç—å
    plt.close()
    #–ó–∞–∫—Ä—ã–≤–∞–∫–º –≥—Ä–∞—Ñ–∏–∫, —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã (–ø–∞–º—è—Ç—å)
    await update.message.reply_photo(photo=buf, caption =f"–ì—Ä–∞—Ñ–∏–∫ –æ–±–º–µ–Ω–Ω–æ–≥–æ –∫—É—Ä—Å–∞ USD –∫ {currency}")

def init_db(): # –§—É–Ω—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤. –û–Ω–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ–∑–¥–∞–Ω–∏—é —Ç–∞–±–ª–∏—Ü.
    """
    –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL, –≤–∫–ª—é—á–∞—è —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü
    """
    try: #–±–ª–æ–∫ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö PostgreSQL —Å –ø–æ–º–æ—â—å—é –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ psycopg2
        conn=psycopg2.connect(URL)
        cursor = conn.cursor()
        
        #–°–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã messages, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.  
        # –ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Å—Ç—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –¢–∞–±–ª–∏—Ü–∞ –∏–º–µ–µ—Ç —Ç—Ä–∏ —Å—Ç–æ–ª–±—Ü–∞: 
        # id: –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á),
        # text: —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è,
        # username: –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ—Ç–ø—Ä–∞–≤–∏–≤—à–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–µ.
        #–ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å cursor.execute.–ó–∞–ø—Ä–æ—Å –ø–∏—à–µ—Ç—Å—è –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –≤ –º–µ—Ç–æ–¥–µ cursor.execute 
        cursor.execute("CREATE TABLE IF NOT EXISTS messages (id SERIAL PRIMARY KEY, text TEXT, username TEXT);") 
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã  message_updates, –µ—Å–ª–∏ –æ–Ω–∞ –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        #–ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
        #–ó–∞–ø—Ä–æ—Å –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π create_table_query —Å –ø–æ—Å–ª–µ–¥—É—é—â–∏–º cursor.execute:
        create_table_query = """
        CREATE TABLE IF NOT EXISTS message_updates (
            id SERIAL PRIMARY KEY,
            message_text TEXT,
            user_id BIGINT,
            user_name TEXT,
            is_bot BOOLEAN,
            message_id INT,
            date TIMESTAMP
        );
        """
        cursor.execute(create_table_query)
        #–≥–¥–µ user_id: –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (BIGINT),
        #is_bot: –±—É–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, —É–∫–∞–∑—ã–≤–∞—é—â–µ–µ, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –±–æ—Ç–æ–º,

        conn.commit()
        cursor.close()
        conn.close()
        print ('–¢–∞–±–ª–∏—Ü—ã message —Å–æ–∑–¥–∞–Ω–∞')
    except Exception as e:
        print(f'–û—à–∏–±–∫–∞:{e}') 

    try:
        conn=psycopg2.connect(URL)
        cursor = conn.cursor()

        # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã rates –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        cursor.execute("""
                       CREATE TABLE IF NOT EXISTS rates 
                       (base_currency TEXT,
                        date DATE,
                        currency TEXT,
                        rate REAL,
                        PRIMARY KEY (base_currency, date, currency));""")

        conn.commit()
        cursor.close()
        conn.close()
        print ('–¢–∞–±–ª–∏—Ü—ã rates —Å–æ–∑–¥–∞–Ω–∞')
    except Exception as e:
        print(f'–û—à–∏–±–∫–∞:{e}') 

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None: 
    """
    –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –æ—Ç–ø—Ä–∞–≤–ª—è—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    """
    await update.message.reply_text("–ü—Ä–∏–≤–µ—Ç, —è –±–æ—Ç —Å –±—É—Ç–∫–µ–º–ø–∞")

async def echo(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –§—É–Ω–∫—Ü–∏—è —ç—Ö–æ-–æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑—É
    """
    
    user_messages = update.message.text 
    user_username = update.message.from_user.username

    await update.message.reply_text(update) #–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ Telegram –ø–µ—Ä–µ–¥–∞–ª –≤ –æ–±—ä–µ–∫—Ç–µ update. 
    #–≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
    await update.message.reply_text(f"–ü—Ä–∏–≤–µ—Ç, @{user_username}! –í—ã –Ω–∞–ø–∏—Å–∞–ª–∏: {user_messages}")#–±–æ—Ç –ø–æ–≤—Ç–æ—Ä—è–µ—Ç —Ç–µ–∫—Å—Ç, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
    await update.message.reply_text(user_username) #–≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–æ, –µ—Å–ª–∏ –±–æ—Ç –ª–æ–≥–∏—Ä—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π 
    #–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏—Ö –∏–º—è –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    try:
        conn=psycopg2.connect(URL)
        cursor=conn.cursor()
        cursor.execute("INSERT INTO messages (text, username) VALUES (%s, %s);", (user_messages, user_username))

        # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ UNIX –≤—Ä–µ–º–µ–Ω–∏ –≤ —Ñ–æ—Ä–º–∞—Ç TIMESTAMP
        # date = datetime.datetime.fromtimestamp(update.message["date"])

        # –í—Å—Ç–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü—É
        insert_query = """
        INSERT INTO message_updates (message_text, user_id, user_name, is_bot, message_id, date)
        VALUES (%s, %s, %s, %s, %s, %s);
        """

        cursor.execute(insert_query, 
        (
            user_messages,
            update.message.from_user.id,
            update.message.from_user.username,
            update.message.from_user.is_bot,
            update.message.message_id,
            update.message.date
        ))

        conn.commit()
        cursor.close()
        conn.close()
    except Exception as e:
        print(f'–û—à–∏–±–∫–∞:{e}')

async def return_all_messages(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏—Ö –æ–±—Ä–∞—Ç–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞
    """
    user_username = update.message.from_user.username

    try:
        conn=psycopg2.connect(URL)
        cursor=conn.cursor()
        cursor.execute(f"SELECT text from messages where username = '{user_username}';")
        #–í—ã–±–∏—Ä–∞–µ–º –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —Ç–∞–±–ª–∏—Ü—ã messages
        result = cursor.fetchall()

        logging.info(result)
        decoded_results = [f' {row[0]}' for row in result]
        logging.info(decoded_results)

        formatted_results = "\n".join(decoded_results)

        await update.message.reply_text(decoded_results)
        await update.message.reply_text(formatted_results)

        conn.commit()
        cursor.close()
        conn.close()
    except Exception as e:
        print(f'–û—à–∏–±–∫–∞:{e}')
        await update.message.reply_text(f'–û—à–∏–±–∫–∞:{e}')

async def delete_all_messages(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏—Ö –æ–±—Ä–∞—Ç–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞
    """
    user_username = update.message.from_user.username

    try:
        conn=psycopg2.connect(URL)
        cursor=conn.cursor()
        cursor.execute(f"DELETE from messages where username = '{user_username}';")
        await update.message.reply_text("Deleted –≤—Å–µ —É–¥–∞–ª–µ–Ω–æ")
#–í –≤–∞—à–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –∏–∑ —Ç–∞–±–ª–∏—Ü—ã messages. 
# –û–¥–Ω–∞–∫–æ, –∑–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É message_updates/ —Ç–æ –µ—Å—Ç—å —Ç–∞–º –º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π
        conn.commit()
        cursor.close()
        conn.close()
    except Exception as e:
        print(f'–û—à–∏–±–∫–∞:{e}')
        await update.message.reply_text(f'–û—à–∏–±–∫–∞:{e}')

async def update_all_messages(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –§—É–Ω–∫—Ü–∏—è –±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –¥–æ–±–∞–≤–ª—è—è —Å–∏–º–≤–æ–ª )
    """
    user_username = update.message.from_user.username

    try:
        conn=psycopg2.connect(URL)
        cursor=conn.cursor()
        cursor.execute(f"UPDATE messages SET text = text || ')' where username = '{user_username}';")
        await update.message.reply_text("Updated")

        conn.commit()
        cursor.close()
        conn.close()
    except Exception as e:
        print(f'–û—à–∏–±–∫–∞:{e}')
        await update.message.reply_text(f'–û—à–∏–±–∫–∞:{e}')
 
def main():

    init_db()#–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, —Å–æ–∑–¥–∞–≤–∞—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã. 
    #–≠—Ç–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–æ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞, —á—Ç–æ–±—ã –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –±—ã–ª–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞.

    #–°–æ–∑–¥–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞:
    application = ApplicationBuilder().token(TOKEN).build()
    #–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥:
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("return_all_messages", return_all_messages))
    application.add_handler(CommandHandler("delete_all_messages", delete_all_messages))
    application.add_handler(CommandHandler("update_all_messages", update_all_messages))
    application.add_handler(CommandHandler("get_historical_rates", get_historical_rates))
    application.add_handler(CommandHandler("get_rates", get_rates))
    application.add_handler(CommandHandler("plot", plot))
    #–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, echo)) #–≠—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –≤—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, 
    #–∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –∫–æ–º–∞–Ω–¥–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, /start)
    #–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞. –ë–æ—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç —Å–ª—É—à–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –º–µ—Ç–æ–¥–∞ run_polling().
    application.run_polling(allowed_updates=Update.ALL_TYPES)

#–ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã
if __name__ == "__main__":
    main()